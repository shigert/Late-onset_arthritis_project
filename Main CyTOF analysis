# CyTOF analysis workflow for myeloid and T-cell compartments
# This script is organized for reproducibility and GitHub sharing.

suppressPackageStartupMessages({
  library(Seurat)
  library(flowCore)
  library(dplyr)
  library(ggplot2)
  library(clustree)
  library(tidyr)
  library(ggsci)
  library(rstatix)
  library(ggpubr)
})

# -------------------------------
# Configuration
# -------------------------------

set.seed(123)

# Use project-relative paths so the script is portable and safe to publish.
# Expected layout:
# - data/fcs/*.fcs
# - data/metadata.tsv
# - data/marker_map.tsv
DATA_DIR <- "data"
FCS_DIR <- file.path(DATA_DIR, "fcs")
METADATA_FILE <- file.path(DATA_DIR, "metadata.tsv")
MARKER_MAP_FILE <- file.path(DATA_DIR, "marker_map.tsv")

OUTPUT_DIR <- "results"
if (!dir.exists(OUTPUT_DIR)) dir.create(OUTPUT_DIR, recursive = TRUE)

OUT_MARKERS <- file.path(OUTPUT_DIR, "markers.csv")
OUT_TMARKERS <- file.path(OUTPUT_DIR, "tallmarkers.csv")
OUT_PROP_TOTAL <- file.path(OUTPUT_DIR, "proportion_total.csv")
OUT_PROP_TCELL <- file.path(OUTPUT_DIR, "proportion_tcell.csv")

DISEASE_LEVELS <- c("ACPA+RA", "ACPA-RA", "PMR")

# -------------------------------
# Utility functions
# -------------------------------

read_and_downsample_fcs <- function(fcs_dir, max_events = 10000) {
  fcs_files <- list.files(fcs_dir, pattern = "\\.fcs$", full.names = TRUE)
  if (length(fcs_files) == 0) {
    stop("No .fcs files found in: ", fcs_dir)
  }

  flow_list <- lapply(fcs_files, function(file_path) {
    ff <- read.FCS(file_path, transformation = FALSE, truncate_max_range = FALSE)
    n_events <- nrow(ff)

    if (n_events > max_events) {
      message("Downsampling ", basename(file_path), ": ", n_events, " -> ", max_events)
      ff <- ff[sample(seq_len(n_events), max_events), ]
    } else {
      message("Keeping all ", n_events, " events from ", basename(file_path))
    }
    ff
  })

  flow_set <- as(flow_list, "flowSet")
  sampleNames(flow_set) <- basename(fcs_files)
  flow_set
}

build_seurat_from_flowset <- function(flow_set, metadata_file, marker_map_file, cofactor = 5) {
  expression_matrix <- fsApply(flow_set, exprs)

  metadata_df <- read.table(metadata_file, header = TRUE, sep = "\t", stringsAsFactors = FALSE)
  sample_ids <- rep(sampleNames(flow_set), fsApply(flow_set, nrow))

  cell_metadata <- data.frame(FileName = sample_ids) %>%
    left_join(metadata_df, by = "FileName")

  cell_ids <- paste0("cell_", seq_len(nrow(expression_matrix)))
  rownames(expression_matrix) <- cell_ids
  rownames(cell_metadata) <- cell_ids

  seurat_obj <- CreateSeuratObject(counts = t(expression_matrix), meta.data = cell_metadata)

  marker_mapping <- read.table(marker_map_file, header = TRUE, sep = "\t", stringsAsFactors = FALSE)
  feature_rename_map <- setNames(marker_mapping$antigen, marker_mapping$fcs_colname)

  new_feature_names <- sapply(marker_mapping$fcs_colname, function(x) {
    if (x %in% names(feature_rename_map)) feature_rename_map[[x]] else x
  }, USE.NAMES = FALSE)

  rownames(seurat_obj[["RNA"]]) <- new_feature_names
  seurat_obj@assays$RNA$data <- asinh(seurat_obj@assays$RNA$counts / cofactor)

  seurat_obj
}

run_harmony_umap <- function(seurat_obj, batch_var = "PatientID", reduction_name = "harmony", key = "harmony_", dims = 1:15) {
  all_markers <- rownames(seurat_obj)
  seurat_obj <- ScaleData(seurat_obj, features = all_markers)
  seurat_obj <- RunPCA(
    seurat_obj,
    features = all_markers,
    npcs = length(all_markers),
    approx = FALSE,
    verbose = FALSE
  )

  pca_embeddings <- Embeddings(seurat_obj, "pca")
  harmony_embeddings <- harmony::RunHarmony(
    data_mat = pca_embeddings,
    meta_data = seurat_obj@meta.data,
    vars_use = batch_var
  )

  rownames(harmony_embeddings) <- rownames(pca_embeddings)
  seurat_obj[[reduction_name]] <- CreateDimReducObject(
    embeddings = harmony_embeddings,
    key = key,
    assay = DefaultAssay(seurat_obj)
  )

  seurat_obj <- RunUMAP(seurat_obj, reduction = reduction_name, dims = dims)
  seurat_obj <- FindNeighbors(seurat_obj, reduction = reduction_name, dims = dims)

  res <- seq(0, 1, 0.1)
  for (i in seq_along(res)) {
    seurat_obj <- FindClusters(seurat_obj, resolution = res[i])
  }

  seurat_obj
}

build_proportion_df <- function(seurat_obj) {
  meta_data <- seurat_obj@meta.data
  meta_data$Cluster <- seurat_obj@active.ident

  cell_counts <- meta_data %>%
    group_by(PatientID, Disease, Cluster) %>%
    summarise(CellCount = n(), .groups = "drop") %>%
    complete(PatientID, Cluster, fill = list(CellCount = 0)) %>%
    group_by(PatientID) %>%
    fill(Disease, .direction = "downup") %>%
    ungroup()

  cell_counts %>%
    group_by(PatientID) %>%
    mutate(
      TotalCellsInSample = sum(CellCount),
      Proportion = CellCount / TotalCellsInSample
    ) %>%
    ungroup()
}

run_kw_and_dunn <- function(proportion_df) {
  kw_results_list <- list()

  for (cluster_id in unique(proportion_df$Cluster)) {
    cluster_data <- proportion_df %>% filter(Cluster == cluster_id)
    kw_result <- kruskal_test(cluster_data, Proportion ~ Disease)

    kw_results_list[[as.character(cluster_id)]] <- kw_result

    cat("=========================================================\n")
    cat("Kruskal-Wallis Results for:", as.character(cluster_id), "\n")
    cat("=========================================================\n")
    print(kw_result)

    p_value <- kw_result$p[1]
    if (!is.na(p_value) && p_value < 0.05) {
      cat("\n--- Dunn's Post-hoc Test (BH-adjusted) ---\n")
      dunn_result <- dunn_test(cluster_data, Proportion ~ Disease, p.adjust.method = "BH")
      print(dunn_result)
    }
    cat("\n\n")
  }

  invisible(kw_results_list)
}

save_composition_plot <- function(seurat_obj, out_file, width, height) {
  plot_df <- data.frame(
    Cluster = Idents(seurat_obj),
    PatientID = seurat_obj$PatientID,
    Disease = seurat_obj$Disease
  )

  count_df <- plot_df %>% count(Disease, PatientID, Cluster)

  p <- ggplot(count_df, aes(x = PatientID, y = n, fill = Cluster)) +
    geom_bar(stat = "identity", position = "fill") +
    facet_grid(~ Disease, scales = "free_x", space = "free_x") +
    scale_y_continuous(labels = scales::percent_format()) +
    labs(x = "Patient ID", y = "%", fill = "Cluster") +
    theme_classic() +
    theme(
      strip.background = element_rect(fill = "grey90", color = NA),
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8, color = "black"),
      axis.text.y = element_text(size = 8, color = "black"),
      axis.title.x = element_text(size = 8, color = "black"),
      axis.title.y = element_text(size = 8, color = "black"),
      legend.position = "none"
    )

  print(p)
  ggsave(out_file, plot = p, width = width, height = height, units = "in")
}

save_disease_summary_plot <- function(proportion_df, cluster_levels, out_file, width, height, nrow_facets = 2) {
  # Enforce display order based on new.cluster.ids definition.
  proportion_df <- proportion_df %>%
    mutate(
      Cluster = factor(as.character(Cluster), levels = unique(cluster_levels)),
      Disease = factor(Disease, levels = DISEASE_LEVELS),
      Percentage = Proportion * 100
    )

  cluster_max_values <- proportion_df %>%
    group_by(Cluster) %>%
    summarise(max_percentage = max(Percentage), .groups = "drop")

  stat_test_initial <- proportion_df %>%
    group_by(Cluster) %>%
    dunn_test(Percentage ~ Disease, p.adjust.method = "BH") %>%
    mutate(
      p.adj.signif = case_when(
        p.adj <= 0.001 ~ "***",
        p.adj <= 0.01 ~ "**",
        p.adj <= 0.05 ~ "*",
        TRUE ~ "ns"
      )
    ) %>%
    add_xy_position(x = "Disease")

  stat_test_adjusted <- stat_test_initial %>%
    left_join(cluster_max_values, by = "Cluster") %>%
    group_by(Cluster) %>%
    mutate(
      step = max_percentage * 0.08,
      y.position = max_percentage + (step * row_number())
    ) %>%
    ungroup()

  p <- ggplot(proportion_df, aes(x = Disease, y = Percentage, fill = Disease)) +
    stat_summary(fun = "mean", geom = "bar", alpha = 0.6, color = "black") +
    stat_summary(fun.data = "mean_se", geom = "errorbar", width = 0.2) +
    geom_jitter(width = 0.2, shape = 21, size = 1.8, stroke = 0.5, fill = "white") +
    stat_pvalue_manual(
      stat_test_adjusted,
      label = "p.adj.signif",
      tip.length = 0.01,
      hide.ns = TRUE
    ) +
    facet_wrap(~ Cluster, scales = "free_y", nrow = nrow_facets) +
    scale_y_continuous(expand = expansion(mult = c(0.05, 0.1))) +
    labs(x = NULL, y = "%") +
    theme_classic() +
    scale_fill_jama() +
    theme(
      axis.text.x = element_blank(),
      axis.text.y = element_text(size = 8, color = "black"),
      axis.ticks.x = element_blank(),
      axis.title.y = element_text(size = 8, color = "black"),
      strip.background = element_blank(),
      strip.text = element_text(size = 8)
    )

  print(p)
  ggsave(out_file, plot = p, width = width, height = height, units = "in")

  invisible(proportion_df)
}

# -------------------------------
# Main analysis: whole CyTOF object
# -------------------------------

flow_set <- read_and_downsample_fcs(FCS_DIR, max_events = 10000)
cytof_seurat <- build_seurat_from_flowset(flow_set, METADATA_FILE, MARKER_MAP_FILE, cofactor = 5)
cytof_seurat <- run_harmony_umap(cytof_seurat, batch_var = "PatientID", reduction_name = "harmony", key = "harmony_")

clustree(cytof_seurat, prefix = "RNA_snn_res.")
cytof_seurat <- FindClusters(cytof_seurat, resolution = 1)

p_after_harmony <- DimPlot(cytof_seurat, reduction = "umap", label = TRUE) + NoLegend() + ggtitle("After Harmony")
p_by_patient_after <- DimPlot(cytof_seurat, reduction = "umap", group.by = "PatientID") + NoLegend() + ggtitle("After Harmony (by Patient)")

cytof_seurat <- RunUMAP(cytof_seurat, reduction = "pca", dims = 1:15, reduction.name = "umap_original")
p_by_patient_before <- DimPlot(cytof_seurat, reduction = "umap_original", group.by = "PatientID") + NoLegend() + ggtitle("Before Harmony (by Patient)")

print(p_by_patient_before | p_by_patient_after)

cytof_seurat$Disease <- factor(cytof_seurat$Disease, levels = DISEASE_LEVELS)

cytof_seurat <- JoinLayers(cytof_seurat)
markers <- FindAllMarkers(cytof_seurat, min.pct = 0.25, only.pos = TRUE, logfc.threshold = 0.5)
write.csv(markers, OUT_MARKERS)

new.cluster.ids <- c(
  "Neutrophil", "Neutrophil", "Neutrophil", "Classical Monocyte", "CD8+ T cell",
  "Intermediate Monocyte", "Intermediate Monocyte", "Neutrophil", "CD4+ T cell", "CD4+ T cell",
  "Neutrophil", "Neutrophil", "Non-Classical Monocyte", "Neutrophil", "Classical Monocyte",
  "CD8+ T cell", "CD4+ T cell", "NK cell", "CD8+ T cell", "NK cell",
  "CD4+ T cell", "Unknown", "Unknown", "Atypical T cell", "Atypical T cell",
  "CD8+ T cell", "Neutrophil", "Unknown"
)

names(new.cluster.ids) <- levels(cytof_seurat)
cytof_seurat <- RenameIdents(cytof_seurat, new.cluster.ids)

p_umap_cytof <- DimPlot(cytof_seurat, reduction = "umap", label = FALSE) +
  theme(text = element_text(size = 8), axis.text = element_text(size = 8))
print(p_umap_cytof)
ggsave("Figure1A.pdf", plot = p_umap_cytof, width = 3.5, height = 2, units = "in")

p_violin_cytof <- VlnPlot(
  cytof_seurat,
  features = c("CD3", "CD4", "CD8a", "CD14", "CD16", "CD19", "CD56", "CD66b", "TCRgd", "IL3R", "CD11c"),
  pt.size = 0,
  stack = TRUE,
  flip = TRUE
) +
  NoLegend() +
  labs(x = NULL) +
  theme(text = element_text(size = 8), axis.text = element_text(size = 8))

print(p_violin_cytof)
ggsave("FigureS2.pdf", plot = p_violin_cytof, width = 3, height = 3, units = "in")

proportion_total <- build_proportion_df(cytof_seurat)
write.csv(proportion_total, OUT_PROP_TOTAL)
run_kw_and_dunn(proportion_total)

save_composition_plot(cytof_seurat, out_file = "Figure1B.pdf", width = 3.5, height = 2)
save_disease_summary_plot(
  proportion_total,
  cluster_levels = new.cluster.ids,
  out_file = "Figure1C.pdf",
  width = 8,
  height = 3,
  nrow_facets = 2
)

# -------------------------------
# Sub-analysis: T-cell subset
# -------------------------------

print(levels(Idents(cytof_seurat)))
tcell_seurat <- subset(cytof_seurat, idents = c("CD4+ T cell", "CD8+ T cell", "Atypical T cell"))
tcell_seurat <- run_harmony_umap(tcell_seurat, batch_var = "PatientID", reduction_name = "harmony_tcell", key = "harmonyT_")

clustree(tcell_seurat, prefix = "RNA_snn_res.")
tcell_seurat <- FindClusters(tcell_seurat, resolution = 0.6)
print(DimPlot(tcell_seurat, reduction = "umap", label = TRUE) + NoLegend())

p_violin_tcell <- VlnPlot(
  tcell_seurat,
  features = c("CD38", "CD56", "TCRgd", "CCR7", "CD161", "CD25", "CD57", "CXCR3", "CXCR5", "CD28", "PD-1",
               "CD4", "CD8a", "CD45RA", "CCR6", "CD45RO", "CCR4", "CD27", "HLA-DR", "CD127"),
  pt.size = 0,
  stack = TRUE,
  flip = TRUE
) +
  NoLegend() +
  labs(x = NULL) +
  theme(text = element_text(size = 8), axis.text = element_text(size = 8))

print(p_violin_tcell)
ggsave("FigureS3.pdf", plot = p_violin_tcell, width = 7, height = 5, units = "in")

tcell_seurat <- JoinLayers(tcell_seurat)
tmarkers <- FindAllMarkers(tcell_seurat, min.pct = 0.25, only.pos = TRUE, logfc.threshold = 0.5)
write.csv(tmarkers, OUT_TMARKERS)

new.cluster.ids <- c(
  "Activated CD8T", "Th17", "CD57+ CD8T", "CM CD8T", "Treg", "senescent CD4T", "Naive CD8T", "Tph",
  "CM CD4T", "CD57+ CD4T", "Th17", "CD161+ CD8T", "Tfh", "Activated CD4T", "CXCR5+ CD8T", "CD56+ CD8T", "gdT"
)

names(new.cluster.ids) <- levels(tcell_seurat)
tcell_seurat <- RenameIdents(tcell_seurat, new.cluster.ids)

p_umap_tcell <- DimPlot(tcell_seurat, reduction = "umap", label = FALSE) +
  theme(text = element_text(size = 8), axis.text = element_text(size = 8))
print(p_umap_tcell)
ggsave("Figure1D.pdf", plot = p_umap_tcell, width = 3, height = 1.8, units = "in")

save_composition_plot(tcell_seurat, out_file = "Figure1E.pdf", width = 5, height = 2)

proportion_tcell <- build_proportion_df(tcell_seurat)
write.csv(proportion_tcell, OUT_PROP_TCELL)
run_kw_and_dunn(proportion_tcell)

save_disease_summary_plot(
  proportion_tcell,
  cluster_levels = new.cluster.ids,
  out_file = "Figure1F.pdf",
  width = 8,
  height = 2.3,
  nrow_facets = 2
)
